# 物模型接入用户示例

[![Language](https://img.shields.io/badge/Language-C-brightgreen.svg?style=flat-square "Language")]()

- [概述](#概述)
- [用户接口说明](#用户接口说明)
- [用户用例说明](#用户用例说明)

## 概述

物模型接入与和物接入类似，都是由根据用户自定义功能点生成的功能点操作接口和SDK通用接口构成。

SDK通用接口位于目录onenet/tm下，功能点操作接口由平台自动生成下载，一般位于应用目录examples/things_model下。

用户用例内置了一个示例用物模型文件“**model-schema.json**”，用户将物模型文件在平台导入一个新产品后，可直接使用示例代码进行调试。

## 用户接口说明

功能点操作接口默认命名为`tm_user.[ch]`。

功能点操作接口主要分为三类：

1. 属性读/写接口

   以用户定义一个名为**switch**的**Bool**型属性功能点为例，平台将为功能点自动生成读/写接口：

   ```c
   int32_t tm_prop_switch_rd_cb(void *data);
   int32_t tm_prop_switch_wr_cb(void *data);
   ```

   接口内部将根据功能点的数据类型，自动使用对应的解析接口从中获取属性值（写接口）或将对应数据类型的属性值写入返回值（读接口）。用户仅需要在接口内实现属性值的生效逻辑（写接口）或属性值的获取逻辑（读接口）即可。

2. 服务执行接口

   服务执行接口定义一般为`tm_svc_xxx_cb`，其中xxx为用户定义的服务名。

   平台生成的服务执行接口中，会构造两个参数结构体，分别为：**in_param**、**out_param**。用户需要根据in_param中的参数值，结合服务定义的执行逻辑，生成服务执行结果并保存到out_param中。接口自动out_param打包为数据回复到平台。

3. 属性/事件上报接口

   上报接口定义为`tm_xxx_yyy_notify`，其中xxx表示属性上报还是事件上报，yyy为用户在平台定义的属性或事件名称。该类接口主要由用户在应用逻辑中主动调用，无需对接口本身进行修改。

## 用户用例说明

- 单个属性/事件功能点上报

  直接调用自动生成的属性功能点上报接口。

- 多个属性功能点组合上报

  多个属性功能点组合上报的伪代码如下：

  ```c
  void *combine = tm_data_create();
  
  /** 根据需要，调用需要上报的属性上报接口，第一个参数固定为创建的combine指针*/
  tm_prop_a_notify(combine, 1, 0, 0);
  tm_prop_b_notify(combine, 3.14, 0, 0);
  
  /** 打包完成后，调用上报接口*/
  tm_post_property(combine, 3000);
  ```
  
- 远程升级OTA

  远程升级的流程可以参考官网文档。
  
  接口调用参考示例代码，主要包括以下步骤：
  
  1. 设备启动后，调用接口`ota_post_version`上报设备当前版本：
  2. 如果使用了**主动通知**方式的远程升级设置，则需要在登录平台时，设置`tm_downlink_tbl_t`的OTA回调接口`ota_cb`；
  3. 平台下发主动通知后，会通过`ota_cb`通知设备，设备做好升级准备后进入升级流程；
  4. 设备调用接口`ota_check_task`获取升级任务相关的属性，包括升级任务ID、目标版本、升级包大小、MD5、完整包或差分包等信息；
  5. 设备使用升级任务ID调用接口`ota_check_token`向平台查询任务状态；
  6. 查询任务正常，则调用`ota_download_package`下载升级包（可循环调用该接口实现分片下载）；
  7. 如果需要使用断点续传，则需要每下载一个包都记录下当前的下载偏移和下载任务ID，如果设备断电或其它原因导致暂时不可下载，待设备恢复后读取下载偏移和升级任务ID，从记录的下载偏移处进行续传；
  8. 升级包下载完成后，使用MD5信息校验升级包完整性。若无误，则按照设备本身的升级方式升级设备；
  9. 设备升级完整后，调用接口`ota_report_status`上报升级状态以及新的设备版本。
